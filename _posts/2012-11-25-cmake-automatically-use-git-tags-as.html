---
title: "CMake: Automatically use git tags as version strings"
layout: "post"
permalink: "/2012/11/cmake-automatically-use-git-tags-as.html"
uuid: "271260801997189329"
guid: "tag:blogger.com,1999:blog-3270817893928434685.post-271260801997189329"
date: "2012-11-25 00:38:00"
updated: "2012-11-25 01:32:42"
description: 
blogger:
    siteid: "3270817893928434685"
    postid: "271260801997189329"
    comments: "0"
categories: [c++, version, git, revisions, cmake]
author: 
    name: "Brian C. Milco"
    url: "http://www.blogger.com/profile/05356031750889872461?rel=author"
    image: "http://img2.blogblog.com/img/b16-rounded.gif"
comments: true
---

{% raw %}
<div class="css-full-post-content js-full-post-content">
<br />If you're like me and you use git to tag your new versions, you'd like your build system to automatically include those git versions when you build a new version of the software. The following instructions will give you one way to do that.<br /><br />First you'll need a way to get the current git tag and hash information into cmake. So you'll want to use the scripts GetGitRevisionDescription.cmake and GetGitRevisionDescription.cmake.in from <a href="https://github.com/rpavlik/cmake-modules">https://github.com/rpavlik/cmake-modules</a>. Add these files to your project. I like to include them in a <span style="font-family: Courier New, Courier, monospace;">[PROJECT]/cmake/modules</span> folder and in your CMakeLists.txt file include that folder in your modules path as follows:<br /><br /><span style="font-family: Courier New, Courier, monospace;"># Appends the cmake/modules path to MAKE_MODULE_PATH variable.</span><br /><span style="font-family: Courier New, Courier, monospace;">set(CMAKE_MODULE_PATH ${CMAKE_CURRENT_SOURCE_DIR}/cmake/modules ${CMAKE_MODULE_PATH})</span><br /><br />Now that you can get the version information in your cmake files you need to parse it and get it into the project how you want.<br /><br />My version strings look like this: "v1.4.0" or "v1.5.2-7-ge3b1138-dirty" with all the git status information, so first I like to parse them and get the major, minor, patch, and sha1 pieces. For most uses I only need <span style="font-family: Courier New, Courier, monospace;">VERSION_MAJOR</span>, <span style="font-family: Courier New, Courier, monospace;">VERSION_MINOR</span>, and <span style="font-family: Courier New, Courier, monospace;">VERSION_PATCH</span>, so I have a <span style="font-family: Courier New, Courier, monospace;">VERSION_SHORT</span> that combines these pieces and allows me to use the version through out the build process and in the cpack packaging process. Also don't forget to add the <span style="font-family: Courier New, Courier, monospace;">${version_file}</span> to the <span style="font-family: Courier New, Courier, monospace;">add_executable</span> line.<br /><br /><span style="font-family: Courier New, Courier, monospace;">#</span><br /><span style="font-family: Courier New, Courier, monospace;"># Make a version file containing the current version from git.</span><br /><span style="font-family: Courier New, Courier, monospace;">#</span><br /><span style="font-family: Courier New, Courier, monospace;">include(GetGitRevisionDescription)</span><br /><span style="font-family: Courier New, Courier, monospace;">git_describe(VERSION --tags --dirty=-dirty)</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">#parse the version information into pieces.</span><br /><span style="font-family: Courier New, Courier, monospace;">string(REGEX REPLACE "^v([0-9]+)\\..*" "\\1" VERSION_MAJOR "${VERSION}")</span><br /><span style="font-family: Courier New, Courier, monospace;">string(REGEX REPLACE "^v[0-9]+\\.([0-9]+).*" "\\1" VERSION_MINOR "${VERSION}")</span><br /><span style="font-family: Courier New, Courier, monospace;">string(REGEX REPLACE "^v[0-9]+\\.[0-9]+\\.([0-9]+).*" "\\1" VERSION_PATCH "${VERSION}")</span><br /><span style="font-family: Courier New, Courier, monospace;">string(REGEX REPLACE "^v[0-9]+\\.[0-9]+\\.[0-9]+(.*)" "\\1" VERSION_SHA1 "${VERSION}")</span><br /><span style="font-family: Courier New, Courier, monospace;">set(VERSION_SHORT "${VERSION_MAJOR}.${VERSION_MINOR}.${VERSION_PATCH}")</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">configure_file(${CMAKE_CURRENT_SOURCE_DIR}/cmake/modules/version.cpp.in</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ${CMAKE_CURRENT_BINARY_DIR}/version.cpp)</span><br /><span style="font-family: Courier New, Courier, monospace;">set(version_file "${CMAKE_CURRENT_BINARY_DIR}/version.cpp")</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">#Add the version_file to the project build.</span><br /><span style="font-family: Courier New, Courier, monospace;">add_executable(${PROJECT_NAME} ${source_files} ${ui_files} ${version_file})</span><br /><br />As you can see above the <span style="font-family: Courier New, Courier, monospace;">configure_file</span> line configures a source file that contains nothing but the version. This source file is in two parts. The version.h header file should be in the source directory of your project so you can include it in your project and work with the version strings. The version.h file should contain the following code:<br /><br /><span style="font-family: Courier New, Courier, monospace;">#ifndef VERSION_H</span><br /><span style="font-family: Courier New, Courier, monospace;">#define VERSION_H</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">#include &lt;QString&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">extern const QString gGIT_VERSION;</span><br /><span style="font-family: Courier New, Courier, monospace;">extern const QString gGIT_VERSION_SHORT;</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">#endif //VERSION_H</span><br /><br />The second part is the version.cpp.in file that I've stored with the other files in <span style="font-family: Courier New, Courier, monospace;">cmake/modules.</span>&nbsp;CMake will automatically replace variables in <span style="font-family: Courier New, Courier, monospace;">configure_file</span> files that start and end with the "@" symbol. When cmake is run it will automatically replace the <span style="font-family: Courier New, Courier, monospace;">@VERSION@</span> and <span style="font-family: Courier New, Courier, monospace;">@VERSION_SHORT@</span> with the correct information that was pulled form git. So the version.cpp.in file should include the following:<br /><br /><span style="font-family: Courier New, Courier, monospace;">#include "../src/version.h" //update as appropriate</span><br /><br /><span style="font-family: Courier New, Courier, monospace;">const QString gGIT_VERSION =&nbsp;</span><span style="font-family: 'Courier New', Courier, monospace;">"@VERSION@"</span><span style="font-family: Courier New, Courier, monospace;">;</span><br /><span style="font-family: Courier New, Courier, monospace;">const QString gGIT_VERSION_SHORT =&nbsp;</span><span style="font-family: 'Courier New', Courier, monospace;">"@VERSION_SHORT@"</span><span style="font-family: Courier New, Courier, monospace;">;</span><br /><br /><br />With all these pieces you should be able to use the gGIT_VERSION and gGIT_VERSION_SHORT anywhere you include the version.h header file or anywhere in your cmake build files.<br /><br />
</div>
{% endraw %}
