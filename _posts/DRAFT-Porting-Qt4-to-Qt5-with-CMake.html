---
title: "Porting Qt4 to Qt5 with CMake"
layout: "post"
permalink: "/Porting-Qt4-to-Qt5-with-CMake.html"
uuid: "7959451116032305887"
guid: "tag:blogger.com,1999:blog-3270817893928434685.post-7959451116032305887"
date: "2013-02-11 07:56:00"
updated: "2013-02-11 07:56:07"
description: 
blogger:
    siteid: "3270817893928434685"
    postid: "7959451116032305887"
    comments: "0"
categories: [qt4, porting, qt, qt5, cmake]
author: 
    name: "Brian C. Milco"
    url: "http://www.blogger.com/profile/05356031750889872461?rel=author"
    image: "http://img2.blogblog.com/img/b16-rounded.gif"
published: "false"
comments: true
---

{% raw %}
<div class="css-full-post-content js-full-post-content">
<br />Before getting started here are the <a href="http://qt-project.org/doc/qt-5.0/qtdoc/cmake-manual.html">most</a>&nbsp;<a href="http://www.kdab.com/using-cmake-with-qt-5/">helpful</a>&nbsp;<a href="http://qt-project.org/doc/qt-5.0/qtdoc/whatsnew.html">pages</a>&nbsp;I've found on this subject and a few with <a href="http://qt-project.org/doc/qt-5.0/qtdoc/obsoleteclasses.html">some</a>&nbsp;<a href="http://qt-project.org/wiki/Transition_from_Qt_4.x_to_Qt5">random</a>&nbsp;<a href="http://qt-project.org/doc/qt-5.0/qtdoc/portingguide.html">tidbits</a>.<br /><br /><h3>Automated changes</h3>First you should use <a href="http://qt.gitorious.org/qt/qtbase/trees/stable/bin">the fixqt4headers.pl script</a>. Run it with the --dry-run flag first and you'll see what changes it's going to make. On one project of ~10,500 lines of code the script made only 1 change. On another project of &lt; 4,000 lines it made 2 changes.<br /><br /><h3>CMake changes</h3>Using the above resources make changes to your cmake files to reference the new Qt5 modular architecture. Here are the key updates that also simplify my cmake files:<br /><pre><ol><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span><br /><li><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">set(CMAKE_AUTOMOC ON)</span></li><br /><li><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">set(CMAKE_INCLUDE_CURRENT_DIR ON)</span></li><br /><li><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">find_package(Qt5Widgets REQUIRED)&nbsp;</span></li><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span><br /><li><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">if (Qt5_POSITION_INDEPENDENT_CODE) &nbsp;</span></li><br /><li><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">    set(CMAKE_POSITION_INDEPENDENT_CODE ON)</span></li><br /><li><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">endif()</span></li><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span><br /><li><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">qt5_add_resources(generated_resource_files ${qrc_files})</span></li><br /><li><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">qt5_wrap_ui(generated_ui_h_files ${ui_files})</span></li><br /></ol><br /></pre>Line by line&nbsp;explanation:<br /><br />1) Set before you list any source files, it will automatically moc any files that have Ui or QOject subclasses. You no longer need to keep track of them and moc them in a separate command.<br /><br /><div>2) For all those auto generated files from moc include the current directory.<br />Duplicate this line and replace Qt5Widgets with the <a href="http://qt-project.org/doc/qt-5.0/qtdoc/modules.html">correct module</a>&nbsp;as needed.<br /><br /><div>4-6) If you get an error stating you need to compile with position independent code use this block<br /><br />7) convert qrc files to compile-able resource files.</div><div><br /><div>8) convert ui files to ui_h header files.<br /><br /><h3>Q_WS* Changes</h3>If you're writing code for multiple target platforms you probably have at least a few lines of code where you've used #ifdef Q_WS_MAC or #ifdef Q_WS_WIN and friends.<br /><br />The Q_WS_* functions have been removed and you'll have to use Q_OS_MAC, Q_OS_WIN32, Q_OS_LINUX, etc or you're code won't be executed.<br /><br />There is a complete list of Q_OS_* definitions in the <a href="http://qt-project.org/doc/qt-5.0/qtcore/qtglobal.html">global module</a>.<br /><br /><h3>Trouble finding FindQt5* cmake modules</h3>I installed Qt5 directly from the qt-projects.org website as it isn't&nbsp;packaged&nbsp;for my distro yet. I installed it system wide in /opt. I got the following error when cmake couldn't find the Qt5 libraries:<br /><br />&nbsp; <span style="font-family: Courier New, Courier, monospace; font-size: x-small;">CMake Error at CMakeLists.txt:114 (find_package):</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; By not providing "FindQt5Widgets.cmake" in CMAKE_MODULE_PATH this project</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; has asked CMake to find a package configuration file provided by</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; "Qt5Widgets", but CMake did not find one.</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; Could not find a package configuration file provided by "Qt5Widgets" with</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; any of the following names:</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; Qt5WidgetsConfig.cmake</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; qt5widgets-config.cmake</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; Add the installation prefix of "Qt5Widgets" to CMAKE_PREFIX_PATH or set</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; "Qt5Widgets_DIR" to a directory containing one of the above files. &nbsp;If</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; "Qt5Widgets" provides a separate development package or SDK, be sure it has</span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; been installed.</span><br /><br />To solve this problem use the following cmake command:<br /><span style="font-size: x-small;"><br /></span><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">$ cmake -DCMAKE_PREFIX_PATH=/opt/Qt5.0.0/5.0.0/gcc_64 ../</span><br /><br />Note that it wont tell you what version of Qt it found like it used to with Qt4, but when you run make it should start ok.<br /><br />As an aside, because I like to see what version of Qt is being used so I added the following line after the find_package() command in my cmake file.<br /><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">message(STATUS "Qt 5 version: " ${Qt5Core_VERSION_STRING})</span><br /><br /><h3>Changes to the API</h3>For the first pass I just want to get the software compiling so I use the&nbsp;compatibility&nbsp;layer from Qt5 to "get back" the depreciated APIs. To enable this layer add the following line to your cmake file:<br /><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">set_property(TARGET ${executable} APPEND PROPERTY COMPILE_DEFINITIONS QT_DISABLE_DEPRECATED_BEFORE=0)</span><br /><br />Once everything builds and works, I removed the above line and updated my code to match the new API. Here are the issues I ran into:<br /><h4>QDesktopServices::storageLocations()</h4>If you load and save files and use the QDesktopServices::storageLocations() you'll need to update them to use <a href="http://qt-project.org/doc/qt-5.0/qtcore/qstandardpaths.html#standardLocations">QStandardPaths::standardLocations()</a> which returns a QStringList or <a href="http://qt-project.org/doc/qt-5.0/qtcore/qstandardpaths.html#writableLocation">QStandardPaths::writableLocation()</a> which returns a QString.<br /><br />The list of storage locations has also been updated to the new location, but the names are the same.<br /><br />So QDesktopServices::DocumentsLocation is now QStandardPaths::DocumentsLocation<br /><br /><h4>QDomDocument and friends</h4>If you are using QDomDocument and friends you need to change your #includes as follows:<br /><br />#include &lt;QtXml/QDomDocument&gt;<br />#include &lt;QtXml/QDomElement&gt;<br /><h4>QGraphicsItem()</h4>I haven't done a complete survey of the QGraphicsItem()s but it looks like they changed the signature on all the constructors, removing the scene parameter.<br /><br />For example QGraphicsTextItem(QGraphicsItem *parent, QGraphicsScene *scene) to QGraphicsTextItem(QGraphicsItem *parent).<br /><br /><h4></h4><h4>QGraphicsScene::itemAt()</h4><div style="font-weight: normal;">http://qt-project.org/doc/qt-5.0/qtwidgets/qgraphicsscene-compat.html -- itemAt</div><div><br /></div><h4>qInstallMsgHandler</h4>qInstallMsgHandler() was replaced with qInstallMessageHandler() there is a new format for the custom message handlers and you should refer to <a href="http://qt-project.org/doc/qt-5.0/qtcore/qtglobal.html#qInstallMessageHandler">the official documentation</a> for details as to how you should format yours.<br /><br />For the inital port it was useful to remove any reference to my custom debug message handlers and just use the built in qDebug(). If you<br /><br /><h3>Finishing Up</h3>Once all the compile errors are cleared up the hard part begins, making sure everything works without crashing. You do have good unit tests don't you?<br /><br /></div></div></div>
</div>
{% endraw %}
